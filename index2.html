<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Buildings Visualization</title>
    <script src="js/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Cormorant+Garamond:400,700&display=swap&subset=vietnamese" rel="stylesheet">
    <style>
        .tooltip {
            position: absolute;
            background: white;
            border: 1px solid #333;
            padding: 8px;
            pointer-events: none;
            font-family: Arial;
            font-size: 12px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        /* 原点标记 */
        .origin-point {
            filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
        }
    </style>
</head>
<body>
   

        

    <script type="module">
    // import * as d3 from "./js/d3.v7.min.js";
    
        // 设置图表尺寸和边距
        const margin = { top: 40, right: 30, bottom: 40, left: 50 };
        const width = 800 - margin.left - margin.right;
        const height = 900 - margin.top - margin.bottom;
        
        // 创建SVG容器
        const svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
        .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
        
        // 添加标题
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", -margin.top + 30)
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .style("font-weight", "bold")


        svg.append("defs").html(`
            <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="8" result="coloredBlur"/>
            <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
            </feMerge>
            </filter>
        `);
        
        // 黄金螺旋参数
        const a = 15; // 初始半径
        const b = 0.306349; // ln(phi)/pi, phi=黄金比例
        const centerX = width / 2;
        const centerY = height / 2;
        
        // 颜色比例尺
        // const color = d3.scaleSequential(d3.interpolateYlOrRd);
        const color = d3.scaleSequential(d3.interpolateRainbow)
        // .domain(d3.extent(data, d => d.hot_sum).reverse());

        // const color = d3.scaleSequential(d3.interpolateRdYlBu)
            // .domain(d3.extent(data, d => d.hot_sum).reverse());

        // 读取数据
        d3.csv("data/2.csv").then(data => {
            // 转换数据类型
            data.forEach(d => {
                d.count = +d.count;
                d.hot_sum = +d.hot_sum;
                d.Year = d.Year || d.year || d.YEAR; // 兼容不同表头
            });
        
            // 计算颜色域
            // color.domain(d3.extent(data, d => d.hot_sum));
            color.domain(d3.extent(data, d => d.hot_sum).reverse());

        
            // 计算最大count用于缩放圆半径
            const maxCount = d3.max(data, d => d.count);
            const rScale = d3.scaleSqrt().domain([0, maxCount]).range([6, 28]);
        
            // 黄金螺旋折点
            const n = data.length;
            const thetaStep = 2 * Math.PI / (n + 1); // 均匀分布
            const points = data.map((d, i) => {
                const theta = i * thetaStep * 2.1; // 2.5可调节螺旋松紧
                // const r = a * Math.exp(b * theta);
                let r = a * Math.exp(b * theta);
                if (+d.Year < 2012) {
                    r = r * 1.2; // 2015年之后的点更靠近中心
                } 
                if (+d.Year > 2015) {
                    r = r * 0.9; // 2015年之后的点更靠近中心
                } 
                if (+d.Year >=2018) {
                    r = r * 0.88; // 2010年之前的点更远离中心
                }   
                console.log('r',+d.Year, r);

                return {
                    x: centerX + r * Math.cos(theta),
                    y: centerY + r * Math.sin(theta),
                    d: d
                };
            });
        
            // 画黄金螺旋曲线
            const spiralLine = d3.line()
                .x(d => d.x)
                .y(d => d.y)
                .curve(d3.curveCardinal);
        
            svg.append("path")
                .datum(points)
                .attr("fill", "none")
                .attr("stroke", "#aaa")
                .attr("stroke-width", 2)
                .attr("d", spiralLine);
        

                // 生成唯一渐变id
            function getGradientId(i) {
                return `radial-gradient-${i}`;
            }

            // 定义渐变
            points.forEach((pt, i) => {
                const grad = svg.append("radialGradient")
                    .attr("id", getGradientId(i))
                    .attr("cx", "50%").attr("cy", "50%").attr("r", "55%");
                grad.append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", color(pt.d.hot_sum))
                    .attr("stop-opacity", 1);
                grad.append("stop")
                    .attr("offset", "80%")
                    .attr("stop-color", "#fff")
                    .attr("stop-opacity", 0.1);
                grad.append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", "#fff")
                    // .attr("stop-color", color(pt.d.hot_sum))
                    .attr("stop-opacity", 0);
            });

            points.forEach((pt, i) => {
                const beams = 50; // 光束数
                const R = rScale(pt.d.count) * 1.1;
                for (let j = 0; j < beams; j++) {
                    const angle = (2 * Math.PI / beams) * j;
                    svg.append("line")
                        .attr("x1", pt.x)
                        .attr("y1", pt.y)
                        .attr("x2", pt.x + Math.cos(angle) * R * 1.3)
                        .attr("y2", pt.y + Math.sin(angle) * R * 1.3)
                        .attr("stroke", color(pt.d.hot_sum))
                        .attr("stroke-width", 2)
                        .attr("stroke-opacity", 0.28)
                        .lower();
                }
            });

                
            // 画圆点
            svg.selectAll("circle")
                .data(points)
                .join("circle")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                // .attr("r", d => rScale(d.d.count))
                // .attr("fill", d => color(d.d.hot_sum))
                .attr("r", d => rScale(d.d.count) * 2.0)
                .attr("fill", (d, i) => `url(#${getGradientId(i)})`)
                .attr("filter", "url(#glow)");
                // .attr("stroke", "#333")
                // .attr("stroke-width", 1.2);
        
            // 年份标签
            svg.selectAll("text.year")
                .data(points)
                .join("text")
                .attr("class", "year")
                // .attr("x", d => d.x)
                // .attr("y", d => d.y - rScale(d.d.count) - 6)
                .attr("x", d => {
                    // 圆心到点的方向向量
                    const dx = d.x - centerX;
                    const dy = d.y - centerY;
                    const len = Math.sqrt(dx*dx + dy*dy);
                    // 延长距离：圆半径+额外距离
                    const r = rScale(d.d.count) * 2.5;
                    const extra = 18; // 你可以调大让标签更远
                    return centerX + (dx / len) * (len + r + extra);
                })
                .attr("y", d => {
                    const dx = d.x - centerX;
                    const dy = d.y - centerY;
                    const len = Math.sqrt(dx*dx + dy*dy);
                    const r = rScale(d.d.count) * 2.5;
                    const extra = .1;
                    return centerY + (dy / len) * (len + r + extra);
                })
                .attr("text-anchor", "middle")
                .attr("font-family", "Cormorant Garamond, vietnamese")
                .attr("font-size", "11px")
                .attr("fill", "#333")
                .text(d => d.d.Year);
        
            // 可选：tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);
        
            svg.selectAll("circle")
                .on("mouseover", (event, d) => {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(
                        `年份: ${d.d.Year}<br>数量: ${d.d.count}<br>热度: ${d.d.hot_sum}`
                    )
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 20) + "px");
                })
                .on("mousemove", (event) => {
                    tooltip.style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 20) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition().duration(200).style("opacity", 0);
                });
        });
    </script>
</body  >
</html>
